# ビジネスルール定義

## 概要
宿泊施設管理システム（PMS）のビジネスルールを定義します。
各条件の目的、使われ方、およびマトリックスや計算式を示します。

---

## 1. 宿泊者名簿管理コンテキスト

### 1.1 宿泊者名簿記入必須

**目的**: 旅館業法に基づき、チェックイン前に全ゲストの宿泊者名簿記入を完了させる

**使われ方**: チェックイン処理時に名簿の記入状態を確認し、未完了の場合は警告を表示する

| 宿泊者名簿記入ステータス | チェックイン可否 |
|------------------------|-----------------|
| 未送信 | 不可（案内送信を促す） |
| 送信済 | 不可（記入を待つ） |
| 記入済 | 条件付き可（確認推奨） |
| 確認済 | 可 |

### 1.2 トークン有効期限

**目的**: 宿泊者名簿記入用トークンのセキュリティを確保する

**使われ方**: トークンURLアクセス時に有効期限を検証し、期限切れの場合は再発行を促す

**計算式**: トークン有効期限 = 発行日時 + 7日間

| 状態 | 対応 |
|------|------|
| 有効期限内 | 記入フォームを表示 |
| 有効期限切れ | エラー表示、再発行案内 |

---

## 2. 予約管理コンテキスト

### 2.1 ダブルブッキング禁止

**目的**: 同一部屋・同一日に複数の予約が重複しないよう在庫管理を厳密に行う

**使われ方**: 予約登録・更新時に在庫を確認し、重複がある場合は警告を表示する

| 在庫状態 | 予約可否 |
|---------|---------|
| 販売可能（残数 > 0） | 可 |
| 満室（残数 = 0） | 不可 |
| 調整中 | 不可（調整完了を待つ） |

### 2.2 チェックイン時刻制約

**目的**: 設定されたチェックイン時刻以降のみチェックイン処理を可能にする

**使われ方**: チェックイン処理時に施設のチェックイン時刻と現在時刻を比較する

| 現在時刻 | チェックイン可否 |
|---------|-----------------|
| チェックイン時刻前 | 不可（時刻を案内） |
| チェックイン時刻以降 | 可 |

### 2.3 チェックアウト時刻制約

**目的**: 設定されたチェックアウト時刻までにチェックアウト処理を完了させる

**使われ方**: チェックアウト処理時に施設のチェックアウト時刻を表示し、超過の場合は延長料金を計算する

| 現在時刻 | 対応 |
|---------|------|
| チェックアウト時刻前 | 通常チェックアウト |
| チェックアウト時刻超過 | 延長料金発生の可能性あり |

### 2.4 在庫数整合性

**目的**: 予約済数 + 残数 = 販売可能数が常に成立することを保証する

**使われ方**: 在庫更新時に整合性チェックを行い、不整合があれば警告を表示する

**計算式**: 販売可能数 = 予約済数 + 残数

| 整合性チェック | 結果 |
|---------------|------|
| 販売可能数 = 予約済数 + 残数 | 正常 |
| 販売可能数 ≠ 予約済数 + 残数 | エラー（修正を促す） |

### 2.5 在庫同期タイミング

**目的**: 予約取込・キャンセル後、即座に外部OTAに在庫を同期する

**使われ方**: 予約状態変更時に自動的に外部システムへの同期処理をトリガーする

| イベント | 同期タイミング |
|---------|---------------|
| 予約取込 | 即時同期 |
| 予約キャンセル | 即時同期 |
| 手動在庫調整 | 即時同期 |

### 2.6 予約変更時の外部通知

**目的**: 予約情報の変更を外部OTAに通知する

**使われ方**: 予約ステータス・部屋・日程等の変更時に外部システムへ通知する

| 予約ステータス | 通知内容 |
|---------------|---------|
| 予約確定 | 新規予約通知 |
| チェックイン済 | ステータス更新通知 |
| チェックアウト済 | ステータス更新通知 |
| キャンセル | キャンセル通知、在庫回復 |
| ノーショー | ステータス更新通知 |

---

## 3. 清掃管理コンテキスト

### 3.1 清掃完了後アサイン

**目的**: 部屋状態がInspected（点検済）またはVacant（待機）の部屋のみチェックイン可能な部屋として割り当てる

**使われ方**: 部屋アサイン時に部屋状態を確認し、条件を満たす部屋のみ表示する

| 部屋状態ステータス | アサイン可否 |
|-------------------|-------------|
| Vacant | 可 |
| Occupied | 不可（滞在中） |
| Dirty | 不可（清掃前） |
| Cleaning | 不可（清掃中） |
| Inspected | 可 |
| Out-of-order | 不可（使用不可） |

### 3.2 清掃優先順位

**目的**: 次回チェックイン予定時刻が早い部屋を優先的に清掃する

**使われ方**: 清掃リスト表示時に優先順位でソートする

| 次回チェックイン予定 | 優先度 |
|--------------------|-------|
| 当日午前 | 最優先（1） |
| 当日午後 | 高（2） |
| 翌日 | 中（3） |
| 未定 | 低（4） |

### 3.3 モバイル操作対応

**目的**: 清掃ステータス更新など現場作業は片手でも操作可能なUIを提供する

**使われ方**: 清掃スタッフ向け画面では大きなボタン、シンプルな操作フローを提供する

| 清掃ステータス | 操作 |
|---------------|------|
| 未着手 | 「清掃開始」ボタン |
| 清掃中 | 「清掃完了」ボタン |
| 清掃完了 | 表示のみ（フロント確認待ち） |
| 点検済 | 表示のみ |

---

## 4. スタッフ・権限管理コンテキスト

### 4.1 権限による機能制限

**目的**: スタッフに割り当てられた権限ロールに応じて、利用可能な機能を制限する

**使われ方**: ログイン時に権限ロールを確認し、メニュー・機能の表示/非表示を制御する

| 権限ロール | スタッフ管理 | 施設管理 | 予約管理 | 清掃管理 | 売上分析 | 外部連携 |
|-----------|------------|---------|---------|---------|---------|---------|
| Admin | 全権限 | 全権限 | 全権限 | 全権限 | 全権限 | 全権限 |
| Reservation Manager | 参照 | 参照 | 全権限 | 参照 | 参照 | 設定可 |
| Front Desk | - | 参照 | 操作可 | 操作可 | - | - |
| Housekeeping | - | - | 参照 | 操作可 | - | - |
| Accounting | - | 参照 | 参照 | - | 全権限 | - |
| Owner View Only | 参照 | 参照 | 参照 | 参照 | 参照 | 参照 |

### 4.2 施設アクセス制限

**目的**: スタッフは自分に割り当てられた施設のみアクセス可能にする

**使われ方**: ログイン後、割り当て施設のみ表示・操作可能にする

| 施設割当 | アクセス可否 |
|---------|-------------|
| 割当あり | 可 |
| 割当なし | 不可（表示されない） |

---

## 5. 料金管理コンテキスト

### 5.1 料金同期タイミング

**目的**: 料金変更後、即座または定期バッチで外部OTAに同期する

**使われ方**: 料金カレンダー更新時に外部連携ステータスを管理する

| 外部連携ステータス | 対応 |
|-------------------|------|
| 未同期 | 同期処理を実行 |
| 同期中 | 処理完了を待つ |
| 同期済 | 正常完了 |
| 同期エラー | エラー原因を確認、再同期 |

### 5.2 キャンセルポリシー適用

**目的**: レートプランに設定されたキャンセルポリシーに従いキャンセル料を計算する

**使われ方**: 予約キャンセル時にキャンセルポリシーに基づいてキャンセル料を計算する

| キャンセルポリシー種別 | キャンセル料率 |
|----------------------|---------------|
| 返金可 | 0%（全額返金） |
| 7日前まで無料 | 7日前以降: 30%～100% |
| 3日前まで無料 | 3日前以降: 50%～100% |
| 返金不可 | 100%（返金なし） |

### 5.3 最小泊数制限

**目的**: レートプランに設定された最小泊数以上の予約のみ受け付ける

**使われ方**: 予約登録時に宿泊日数とレートプランの最小泊数を比較する

| 宿泊日数 vs 最小泊数 | 予約可否 |
|--------------------|---------|
| 宿泊日数 >= 最小泊数 | 可 |
| 宿泊日数 < 最小泊数 | 不可 |

---

## 6. 施設・部屋管理コンテキスト

### 6.1 収容人数制限

**目的**: 部屋タイプの収容可能人数を超える予約は受け付けない

**使われ方**: 予約登録時に宿泊人数と部屋タイプの収容可能人数を比較する

| 宿泊人数 vs 収容可能人数 | 予約可否 |
|------------------------|---------|
| 宿泊人数 <= 収容可能人数 | 可 |
| 宿泊人数 > 収容可能人数 | 不可 |

### 6.2 複数施設での施設切替

**目的**: 複数施設を管理するユーザーは、施設を意識せずシームレスに切り替えられる

**使われ方**: 画面上部に施設切替ドロップダウンを配置し、即座に切り替え可能にする

| 管理施設数 | 表示 |
|-----------|------|
| 1施設 | 切替不要（固定表示） |
| 2施設以上 | 切替ドロップダウン表示 |

---

## 7. 売上分析コンテキスト

### 7.1 売上計上タイミング

**目的**: チェックアウト完了時に売上を確定・計上する

**使われ方**: チェックアウト処理完了時に自動的に売上レコードを作成する

| チェックアウト状態 | 売上計上 |
|-------------------|---------|
| チェックアウト前 | 未計上 |
| チェックアウト完了 | 計上 |

### 7.2 ADR計算式（Average Daily Rate）

**目的**: 平均客室単価を算出し、料金戦略の評価に活用する

**計算式**:
```
ADR = 総売上金額 ÷ 販売客室数
```

| 項目 | 説明 |
|------|------|
| 総売上金額 | 対象期間の客室売上合計 |
| 販売客室数 | 対象期間の販売された客室数 |
| ADR | 1客室あたりの平均売上 |

### 7.3 OCC計算式（Occupancy Rate）

**目的**: 稼働率を算出し、販売効率の評価に活用する

**計算式**:
```
OCC（稼働率）= 販売客室数 ÷ 総客室数 × 100
```

| 項目 | 説明 |
|------|------|
| 販売客室数 | 対象期間の販売された客室数 |
| 総客室数 | 対象期間の販売可能な総客室数 |
| OCC | 稼働率（%） |

### 7.4 RevPAR計算式（Revenue Per Available Room）

**目的**: 客室あたり収益を算出し、収益性の総合評価に活用する

**計算式**:
```
RevPAR = ADR × OCC
または
RevPAR = 総売上金額 ÷ 総客室数
```

| 項目 | 説明 |
|------|------|
| ADR | 平均客室単価 |
| OCC | 稼働率 |
| RevPAR | 客室あたり収益 |

---

## 8. 外部連携コンテキスト

### 8.1 外部システム切替時の整合性

**目的**: サイトコントローラー変更時も予約・在庫・料金データの整合性を保つ

**使われ方**: サイトコントローラー切替時に既存データの移行・検証を行う

| サイトコントローラー種別 | 切替時の対応 |
|------------------------|-------------|
| ねっぱん | API接続設定変更、マッピング確認 |
| Beds24 | API接続設定変更、マッピング確認 |
| TL-Lincoln | API接続設定変更、マッピング確認 |
| 手動連携 | 手動同期プロセスの確認 |

---

## 状態遷移に関するビジネスルール

### 予約状態遷移ルール

```
予約確定 → チェックイン済（チェックイン処理時）
チェックイン済 → チェックアウト済（チェックアウト処理時）
予約確定 → キャンセル（キャンセル処理時）
予約確定 → ノーショー（チェックイン予定日経過後）
```

### 部屋状態遷移ルール

```
Vacant → Occupied（チェックイン時）
Occupied → Dirty（チェックアウト時）
Dirty → Cleaning（清掃開始時）
Cleaning → Inspected（清掃完了・点検完了時）
Inspected → Vacant（点検承認時）
Vacant ↔ Out-of-order（故障/修復時）
```

### 清掃状態遷移ルール

```
未着手 → 清掃中（清掃開始時）
清掃中 → 清掃完了（清掃完了時）
清掃完了 → 点検済（フロント確認完了時）
```

### 宿泊者名簿記入状態遷移ルール

```
未送信 → 送信済（案内送信時）
送信済 → 記入済（ゲスト記入完了時）
記入済 → 確認済（フロント確認完了時）
```

### 在庫状態遷移ルール

```
販売可能 → 満室（残数が0になった時）
満室 → 販売可能（キャンセルで在庫回復時）
販売可能 → 調整中（手動調整開始時）
調整中 → 販売可能（調整完了時）
```
