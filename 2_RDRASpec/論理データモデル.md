# 論理データモデル

## 概要
宿泊施設管理システム（PMS）の論理データモデルを示します。
本モデルは、スタッフ・権限管理、施設・部屋管理、料金管理、予約管理、宿泊者名簿管理、清掃管理、売上分析、外部連携の各コンテキストを網羅しています。

## ER図

```mermaid
erDiagram
    %% スタッフ・権限管理コンテキスト
    スタッフ {
        number スタッフ_ID PK
        string 名前
        string メールアドレス
        string パスワード
        string 連絡先
        string 所属部門
        number 権限_ID FK
        string 登録日
        string 最終ログイン日時
    }

    権限 {
        number 権限_ID PK
        enum ロール名
        string 利用可能機能リスト
        string 表示可能項目リスト
        string 説明
    }

    スタッフ施設割当 {
        number スタッフ施設割当_ID PK
        number スタッフ_ID FK
        number 施設_ID FK
    }

    %% 施設・部屋管理コンテキスト
    施設 {
        number 施設_ID PK
        string 施設名
        string 住所
        string 郵便番号
        string 電話番号
        string アクセス方法
        string チェックイン時刻
        string チェックアウト時刻
        string 施設説明
        string 登録日
    }

    部屋タイプ {
        number 部屋タイプ_ID PK
        string タイプ名
        number 施設_ID FK
        number 収容可能人数
        number 最小人数
        enum 喫煙可否
        enum ベッドタイプ
        number ベッド数
        string 設備リスト
        number 広さ
        number 基準料金
        string 説明
    }

    部屋 {
        number 部屋_ID PK
        string 部屋番号
        number 施設_ID FK
        number 部屋タイプ_ID FK
        string 外部連携用ID
        string フロア
        string 設備特記事項
        string 登録日
    }

    部屋状態 {
        number 部屋状態_ID PK
        number 部屋_ID FK
        enum 現在ステータス
        enum 前回ステータス
        string 最終更新日時
        string 次回チェックイン予定日時
        number 更新者スタッフ_ID FK
    }

    %% 料金管理コンテキスト
    シーズン {
        number シーズン_ID PK
        string シーズン名
        number 施設_ID FK
        string 開始日
        string 終了日
        number 料金倍率
        enum シーズン区分
        string 説明
        string 登録日
    }

    レートプラン {
        number レートプラン_ID PK
        string プラン名
        number 施設_ID FK
        number 部屋タイプ_ID FK
        number 基準料金
        string 適用条件
        number 割引率
        enum レートプラン種別
        enum キャンセルポリシー種別
        number 最小泊数
        string 説明
        string 登録日
    }

    料金カレンダー {
        number 料金カレンダー_ID PK
        number 施設_ID FK
        number 部屋タイプ_ID FK
        string 対象日
        number レートプラン_ID FK
        number 料金
        number シーズン_ID FK
        enum 曜日区分
        string 最終更新日時
        enum 外部連携ステータス
    }

    %% 予約管理コンテキスト
    ゲスト {
        number ゲスト_ID PK
        string 氏名
        string フリガナ
        string メールアドレス
        string 電話番号
        string 国籍
        string 言語
        string 会員番号
        number 過去宿泊回数
        string 登録日
    }

    予約 {
        number 予約_ID PK
        string 予約番号
        number ゲスト_ID FK
        number 部屋タイプ_ID FK
        number 部屋_ID FK
        number 施設_ID FK
        string チェックイン日
        string チェックアウト日
        number 宿泊人数
        number 大人数
        number 子供数
        enum 予約ステータス
        enum 流入元OTA
        number 料金合計
        number 手数料
        number レートプラン_ID FK
        string 特記事項
        string 予約日時
        string 最終更新日時
    }

    在庫 {
        number 在庫_ID PK
        number 施設_ID FK
        number 部屋タイプ_ID FK
        string 対象日
        number 販売可能数
        number 予約済数
        number 残数
        enum 在庫状態
        string 最終更新日時
        enum 外部連携ステータス
    }

    %% 宿泊者名簿管理コンテキスト
    宿泊者名簿 {
        number 宿泊者名簿_ID PK
        number 予約_ID FK
        number ゲスト_ID FK
        string 氏名
        string 住所
        string 郵便番号
        string 電話番号
        string 職業
        string 国籍
        string パスポート番号
        string 記入日時
        enum 記入ステータス
        number 確認者スタッフ_ID FK
        string 確認日時
    }

    チェックイン案内 {
        number チェックイン案内_ID PK
        number 予約_ID FK
        string 送信日時
        string 送信先メールアドレス
        string トークンURL
        string トークン有効期限
        number 記入完了フラグ
        string 記入完了日時
    }

    %% 清掃管理コンテキスト
    清掃 {
        number 清掃_ID PK
        number 部屋_ID FK
        number 施設_ID FK
        string 清掃日
        enum 清掃ステータス
        number 担当清掃スタッフ_ID FK
        string 開始日時
        string 完了日時
        string 備品不足情報
        string 特記事項
    }

    %% 売上分析コンテキスト
    売上 {
        number 売上_ID PK
        number 予約_ID FK
        number 施設_ID FK
        number 部屋タイプ_ID FK
        string 宿泊日
        number 売上金額
        number OTA手数料
        number OTA手数料率
        number 純利益
        enum 流入元OTA
        string 計上日
        string 会計期
    }

    %% 外部連携コンテキスト
    外部連携設定 {
        number 外部連携設定_ID PK
        number 施設_ID FK
        enum サイトコントローラー種別
        string APIキー
        string APIシークレット
        string 外部施設ID
        string 外部部屋マッピング
        string 同期方式
        number 連携有効フラグ
        string 最終同期日時
    }

    %% リレーションシップ
    権限 ||--o{ スタッフ : "has"
    スタッフ ||--o{ スタッフ施設割当 : "assigned"
    施設 ||--o{ スタッフ施設割当 : "assigned"

    施設 ||--o{ 部屋タイプ : "has"
    施設 ||--o{ 部屋 : "has"
    部屋タイプ ||--o{ 部屋 : "has"
    部屋 ||--|| 部屋状態 : "has"
    スタッフ ||--o{ 部屋状態 : "updates"

    施設 ||--o{ シーズン : "has"
    施設 ||--o{ レートプラン : "has"
    部屋タイプ ||--o{ レートプラン : "has"
    施設 ||--o{ 料金カレンダー : "has"
    部屋タイプ ||--o{ 料金カレンダー : "has"
    レートプラン ||--o{ 料金カレンダー : "has"
    シーズン ||--o{ 料金カレンダー : "applies"

    ゲスト ||--o{ 予約 : "makes"
    施設 ||--o{ 予約 : "has"
    部屋タイプ ||--o{ 予約 : "has"
    部屋 ||--o{ 予約 : "assigned"
    レートプラン ||--o{ 予約 : "applies"

    施設 ||--o{ 在庫 : "has"
    部屋タイプ ||--o{ 在庫 : "has"

    予約 ||--o{ 宿泊者名簿 : "has"
    ゲスト ||--o{ 宿泊者名簿 : "fills"
    スタッフ ||--o{ 宿泊者名簿 : "confirms"

    予約 ||--o{ チェックイン案内 : "has"

    部屋 ||--o{ 清掃 : "has"
    施設 ||--o{ 清掃 : "has"
    スタッフ ||--o{ 清掃 : "performs"

    予約 ||--o{ 売上 : "generates"
    施設 ||--o{ 売上 : "has"
    部屋タイプ ||--o{ 売上 : "has"

    施設 ||--o{ 外部連携設定 : "has"
```

## コンテキスト別データ構成

### 1. スタッフ・権限管理コンテキスト
- **スタッフ**: システムを利用するスタッフ情報
- **権限**: スタッフに付与する権限ロール
- **スタッフ施設割当**: スタッフと施設の多対多関係を管理

### 2. 施設・部屋管理コンテキスト
- **施設**: 宿泊施設の基本情報
- **部屋タイプ**: 部屋の種類（シングル、ツインなど）
- **部屋**: 実際の部屋情報
- **部屋状態**: 部屋の現在の状態（Vacant、Occupied等）

### 3. 料金管理コンテキスト
- **シーズン**: 繁忙期・閑散期などのシーズン設定
- **レートプラン**: 料金プラン設定
- **料金カレンダー**: 日別の料金設定

### 4. 予約管理コンテキスト
- **ゲスト**: 宿泊者の基本情報
- **予約**: 予約情報
- **在庫**: 部屋タイプ別・日別の在庫管理

### 5. 宿泊者名簿管理コンテキスト
- **宿泊者名簿**: 旅館業法に基づく宿泊者名簿
- **チェックイン案内**: ゲストへの案内メール管理

### 6. 清掃管理コンテキスト
- **清掃**: 部屋ごとの清掃作業管理

### 7. 売上分析コンテキスト
- **売上**: 売上データ（ADR、OCC、RevPAR計算の基礎データ）

### 8. 外部連携コンテキスト
- **外部連携設定**: サイトコントローラー連携設定

## 状態モデル

### 予約状態
- 予約確定 → チェックイン済 → チェックアウト済
- 予約確定 → キャンセル
- 予約確定 → ノーショー

### 部屋状態
- Vacant → Occupied → Dirty → Cleaning → Inspected → Vacant
- Vacant ↔ Out-of-order

### 清掃状態
- 未着手 → 清掃中 → 清掃完了 → 点検済

### 宿泊者名簿記入状態
- 未送信 → 送信済 → 記入済 → 確認済

### 在庫状態
- 販売可能 ↔ 満室
- 販売可能 ↔ 調整中
