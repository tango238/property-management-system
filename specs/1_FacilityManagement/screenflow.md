# 画面遷移図 - 施設管理

## 概要

施設管理機能は、宿泊施設の基本情報、部屋タイプ、部屋の登録・更新・削除・参照を行う機能です。施設管理者が施設運営の基盤データを管理し、フロントスタッフや清掃スタッフが日常業務で部屋状態を操作します。

## ユーザーロール

- **施設管理者**: 施設の基本情報、部屋タイプ、部屋の登録・更新・削除を担当する責任者
- **予約管理担当者**: 予約業務を担当し、施設や部屋タイプの情報を参照するスタッフ
- **フロントスタッフ**: チェックイン・チェックアウト業務を担当し、部屋状態を管理するスタッフ
- **清掃スタッフ**: 部屋の清掃を担当し、清掃状況を報告するスタッフ

---

## 施設管理者のフロー

### メインフロー: 施設管理

```
[1] 施設検索画面
├─→ [2] 施設登録画面 (アクション: 新規登録)
│   └─→ [1] 施設検索画面 (成功時)
├─→ [3] 施設詳細画面 (アクション: 詳細表示)
│   ├─→ [4] 施設更新画面 (アクション: 編集)
│   │   └─→ [3] 施設詳細画面 (成功時)
│   ├─→ [5] 部屋タイプ検索画面 (アクション: 部屋タイプ管理)
│   └─→ [6] 部屋検索画面（管理者） (アクション: 部屋管理)
└─→ [7] 削除確認ダイアログ (アクション: 削除)
    └─→ [1] 施設検索画面 (成功時)
```

関連ユースケース:
- 施設一覧の検索・確認
- 新規施設の登録
- 施設情報の更新
- 施設情報の削除

### メインフロー: 部屋タイプ管理

```
[5] 部屋タイプ検索画面
├─→ [8] 部屋タイプ登録画面 (アクション: 新規登録)
│   └─→ [5] 部屋タイプ検索画面 (成功時)
├─→ [9] 部屋タイプ更新画面 (アクション: 編集)
│   └─→ [5] 部屋タイプ検索画面 (成功時)
└─→ [10] 削除確認ダイアログ (アクション: 削除)
    ├─→ [5] 部屋タイプ検索画面 (成功時)
    └─→ エラー表示 (紐づく部屋が存在する場合)
```

関連ユースケース:
- 部屋タイプ一覧の検索・参照
- 新規部屋タイプの登録
- 部屋タイプの料金改定
- 部屋タイプの削除

### メインフロー: 部屋管理

```
[6] 部屋検索画面（管理者）
├─→ [11] 部屋登録画面 (アクション: 新規登録)
│   └─→ [6] 部屋検索画面（管理者） (成功時)
├─→ [12] 部屋更新画面 (アクション: 編集)
│   ├─→ [6] 部屋検索画面（管理者） (成功時)
│   └─→ エラー表示 (予約がある部屋をOut-of-orderにする場合)
└─→ [13] 削除確認ダイアログ (アクション: 削除)
    ├─→ [6] 部屋検索画面（管理者） (成功時)
    └─→ エラー表示 (予約がある部屋、または使用中の部屋の場合)
```

関連ユースケース:
- 部屋一覧の検索・参照
- 新規部屋の登録
- 部屋のメンテナンス開始
- 部屋情報の削除

---

## 予約管理担当者のフロー

### メインフロー: 施設・部屋タイプ参照

```
[14] 施設詳細画面（予約担当者）
└─→ [15] 部屋タイプ比較画面 (アクション: 部屋タイプ一覧表示)
    ├─→ 検索条件で絞り込み (施設、収容人数、喫煙可否)
    └─→ 部屋タイプ詳細表示 (アクション: 詳細表示)
```

関連ユースケース:
- 施設詳細情報の参照
- 部屋タイプの比較確認

---

## フロントスタッフのフロー

### メインフロー: チェックイン処理

```
[16] 空き部屋検索画面
↓ 空き部屋を検索 (Vacant状態のみ表示)
↓ 部屋を選択
[17] チェックイン画面
├─→ [17] チェックイン画面 (部屋状態がVacantでない場合: エラー)
└─→ チェックイン完了 (成功時: 部屋状態をOccupiedに変更)
```

関連ユースケース:
- 空き部屋の検索・確認
- チェックイン処理

### メインフロー: チェックアウト処理

```
[18] チェックアウト画面
↓ 部屋番号を選択
├─→ [18] チェックアウト画面 (部屋状態がOccupiedでない場合: エラー)
└─→ チェックアウト完了 (成功時: 部屋状態をDirtyに変更)
    └─→ 清掃スタッフへ自動通知
```

関連ユースケース:
- チェックアウト後の清掃依頼

### メインフロー: 検査合格後の部屋開放

```
[19] 部屋状態変更画面
↓ Inspected状態の部屋をフィルタ
↓ 部屋を選択
├─→ [19] 部屋状態変更画面 (Inspected以外の状態: エラー)
└─→ 状態変更完了 (成功時: 部屋状態をVacantに変更)
```

関連ユースケース:
- 検査合格後の部屋開放

---

## 清掃スタッフのフロー

### メインフロー: 清掃業務

```
[20] 清掃対象部屋一覧画面
↓ 清掃対象を確認 (Dirty/Cleaning状態のみ表示)
↓ 部屋を選択
[21] 清掃開始画面
├─→ [21] 清掃開始画面 (Dirty以外の状態: エラー)
└─→ 清掃開始 (成功時: 部屋状態をCleaningに変更)
    ↓
    [22] 清掃完了報告画面
    ├─→ [22] 清掃完了報告画面 (Cleaning以外の状態: エラー)
    └─→ 清掃完了 (成功時: 部屋状態をInspectedに変更)
        └─→ フロントスタッフへ検査依頼通知
```

関連ユースケース:
- 清掃対象部屋の確認
- 清掃開始の記録
- 清掃完了報告

---

## 部屋状態遷移図

```
                    ┌─────────────────┐
                    │     Vacant      │ ←───────────────────────────────┐
                    │   (空き部屋)    │                                  │
                    └────────┬────────┘                                  │
                             │                                           │
           チェックイン      │                                           │
        (フロントスタッフ)   ↓                                           │
                    ┌────────┴────────┐                                  │
                    │    Occupied     │                                  │
                    │    (使用中)     │                                  │ 検査合格
                    └────────┬────────┘                                  │ (フロントスタッフ)
                             │                                           │
          チェックアウト     │                                           │
        (フロントスタッフ)   ↓                                           │
                    ┌────────┴────────┐                                  │
                    │      Dirty      │                                  │
                    │   (要清掃)      │                                  │
                    └────────┬────────┘                                  │
                             │                                           │
            清掃開始         │                                           │
          (清掃スタッフ)     ↓                                           │
                    ┌────────┴────────┐                                  │
                    │    Cleaning     │                                  │
                    │    (清掃中)     │                                  │
                    └────────┬────────┘                                  │
                             │                                           │
            清掃完了         │                                           │
          (清掃スタッフ)     ↓                                           │
                    ┌────────┴────────┐                                  │
                    │   Inspected    │──────────────────────────────────┘
                    │   (検査待ち)    │
                    └─────────────────┘


                    ┌─────────────────┐
                    │  Out-of-order   │ ←──── メンテナンス開始 (施設管理者)
                    │ (使用不可)      │ ────→ メンテナンス完了 (施設管理者) → Vacant
                    └─────────────────┘
```

---

## 重要な遷移

### 施設登録から部屋登録までのフロー

- **起点**: 施設検索画面
- **終点**: 部屋登録画面
- **トリガー**: 新規施設の開業準備
- **条件**: 施設が登録済み、部屋タイプが登録済み
- **関連ユースケース**: 新規施設の登録 → 新規部屋タイプの登録 → 新規部屋の登録
- **備考**: 施設 → 部屋タイプ → 部屋 の順序で登録が必要

### チェックイン処理

- **起点**: 空き部屋検索画面
- **終点**: チェックイン画面
- **トリガー**: 顧客の到着
- **条件**: 部屋状態がVacant
- **関連ユースケース**: 空き部屋の検索・確認、チェックイン処理
- **備考**: 予約番号がある場合は予約情報と照合

### チェックアウトから清掃完了までのフロー

- **起点**: チェックアウト画面
- **終点**: 部屋状態変更画面
- **トリガー**: 顧客のチェックアウト
- **条件**: 各ステップで適切な部屋状態であること
- **関連ユースケース**: チェックアウト後の清掃依頼 → 清掃開始の記録 → 清掃完了報告 → 検査合格後の部屋開放
- **備考**: 清掃スタッフとフロントスタッフの連携が必要

### 部屋のメンテナンス設定

- **起点**: 部屋検索画面（管理者）
- **終点**: 部屋更新画面
- **トリガー**: メンテナンス必要の判断
- **条件**: 対象部屋に予約がないこと
- **関連ユースケース**: 部屋のメンテナンス開始
- **備考**: Out-of-order状態の部屋は予約対象から自動除外

---

## 外部連携ポイント

本機能は施設管理のみを扱うため、外部システムとの連携はありません。
ただし、以下の機能との内部連携が想定されます：

- **予約管理機能**: 部屋の予約可否判定、予約情報の参照
- **料金管理機能**: 部屋タイプの標準料金を基にした料金計算

---

## エラーフロー

### 施設削除時のエラー

```
[1] 施設検索画面
↓ 削除ボタンクリック
[7] 削除確認ダイアログ
↓ 確認ボタンクリック
├─→ 成功: 施設検索画面へ戻る
└─→ 失敗: エラーメッセージ表示
    - "関連する予約が存在するため削除できません"
    - "部屋タイプが存在するため削除できません"
```

### 部屋タイプ削除時のエラー

```
[5] 部屋タイプ検索画面
↓ 削除ボタンクリック
[10] 削除確認ダイアログ
↓ 確認ボタンクリック
├─→ 成功: 部屋タイプ検索画面へ戻る
└─→ 失敗: エラーメッセージ表示
    - "紐づく部屋が存在するため削除できません"
```

### 部屋状態変更時のエラー

```
[12] 部屋更新画面 / [17] チェックイン画面 / etc.
↓ 状態変更実行
├─→ 成功: 状態変更完了
└─→ 失敗: エラーメッセージ表示
    - "現在の状態からは変更できません"
    - "予約が存在するため変更できません"
```

---

## 備考

- 部屋状態の遷移は厳密に管理され、不正な遷移は許可されません
- Out-of-order状態への変更は施設管理者のみが実行可能です
- 削除操作は関連データの有無を確認してから実行されます
- 各画面には確認ダイアログが設置され、誤操作を防止します
