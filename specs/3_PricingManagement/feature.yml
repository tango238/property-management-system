actor:
  - name: 施設管理者
    description: 宿泊施設の料金設定を担当する責任者。シーズン料金の設定やレートプランの管理を通じて、収益最大化と競争力のある価格戦略を実現する。

  - name: 予約管理担当者
    description: 予約業務を担当し、シーズン料金やレートプランの情報を参照して顧客対応を行うスタッフ。料金の適用状況を確認し、正確な見積もりを提供する。

external_system:
  - name: サイトコントローラー
    description: 楽天トラベル、じゃらん、Booking.com等のOTAへ料金・在庫情報を一括配信するシステム。レートプランの登録・更新時に自動同期を行い、各OTAの料金を統一管理する。対応システムはねっぱん、Beds24、TL-Lincolnなど。

aggregate:
  - シーズン
  - レートプラン
  - 部屋タイプ
  - OTA

feature:
  - name: シーズンの登録・更新・削除
    description: 施設管理者がシーズン（通常期、繁忙期、閑散期、特別期間）を管理する。各シーズンには期間と料金倍率を設定し、予約日に応じた動的価格設定の基盤を構築する。
    events:
      - シーズンが登録された
      - シーズンが更新された
      - シーズンが削除された
    policy:
      - name: レートプラン再計算ポリシー
        trigger: シーズンが更新された
        action: 該当シーズンに紐づくレートプランの料金を再計算し、サイトコントローラーへの同期をスケジュールする
      - name: シーズン削除検証ポリシー
        trigger: シーズンが削除された
        action: 該当シーズンを参照しているレートプランの存在を確認し、存在する場合は警告を発する
    scenarios:
      - name: 年間シーズン計画の設定フロー
        precondition: 施設管理者がログイン済み、翌年度の営業計画が確定している
        steps:
          - シーズン一覧画面から現在のシーズン設定を確認する
          - 新規シーズン登録画面を開き、繁忙期（GW、お盆、年末年始等）を登録する
          - 料金倍率を設定する（例：繁忙期は1.5倍）
          - 閑散期（平日、オフシーズン）を登録し、料金倍率を設定する（例：0.8倍）
          - 特別期間（地域イベント期間等）を必要に応じて登録する
          - 登録したシーズン設定をプレビューで確認し、確定する
        postcondition: 年間のシーズン料金体系が設定され、予約時に自動適用される状態になる
      - name: 既存シーズンの期間調整フロー
        precondition: 繁忙期の日程変更が必要になった
        steps:
          - シーズン検索画面で該当シーズンを検索する
          - シーズン詳細を開き、現在の期間設定を確認する
          - シーズン更新画面で期間を変更する
          - 変更による影響（既存予約への影響等）を確認する
          - 更新を確定し、レートプランへの反映を確認する
        postcondition: シーズン期間が更新され、関連するレートプランの料金が再計算される

  - name: シーズン情報の検索・参照
    description: 施設管理者および予約管理担当者がシーズン設定を検索・参照する。期間やシーズン区分での絞り込みにより、料金設定の確認や顧客への説明に活用する。
    events:
      - シーズン検索が実行された
    policy: []
    scenarios:
      - name: 顧客問い合わせ対応での料金確認フロー
        precondition: 顧客から特定日程の料金問い合わせがあった
        steps:
          - シーズン検索画面を開く
          - 問い合わせ日程を指定してシーズンを検索する
          - 該当日程に適用されるシーズン区分と料金倍率を確認する
          - 部屋タイプの標準料金にシーズン倍率を適用した概算料金を顧客に案内する
        postcondition: 顧客に正確なシーズン料金情報が提供される

  - name: レートプランの登録・更新・削除
    description: 施設管理者がOTA別・部屋タイプ別のレートプラン（料金体系）を管理する。各OTAの手数料率や競合状況を考慮した価格設定を行い、収益を最適化する。
    events:
      - レートプランが登録された
      - レートプランが更新された
      - レートプランが削除された
    policy:
      - name: サイトコントローラー自動同期ポリシー
        trigger: レートプランが登録された
        action: 新規レートプランをサイトコントローラー経由で該当OTAに自動配信する
      - name: 料金更新同期ポリシー
        trigger: レートプランが更新された
        action: 更新されたレートプラン情報をサイトコントローラー経由で該当OTAに即時反映する
      - name: OTA料金削除同期ポリシー
        trigger: レートプランが削除された
        action: 該当OTAからレートプランを削除（または販売停止）する指示をサイトコントローラーに送信する
    scenarios:
      - name: 新規OTA販売開始フロー
        precondition: 新しいOTA（例：Booking.com）との契約が完了し、販売開始準備が整っている
        steps:
          - レートプラン登録画面を開く
          - OTA種別でBooking.comを選択する
          - 対象の部屋タイプを選択する
          - 各シーズンに対応した料金を設定する（OTA手数料を考慮）
          - 販売期間を設定する
          - レートプランを登録し、サイトコントローラーへの同期を実行する
          - Booking.comの管理画面で料金が反映されていることを確認する
        postcondition: 新規OTAでの販売が開始され、料金が正しく表示される
      - name: 全OTA一斉料金改定フロー
        precondition: 仕入れコスト上昇により全OTAの料金見直しが必要になった
        steps:
          - レートプラン一覧画面で現在の料金設定を確認する
          - 部屋タイプごとに新料金を計算する
          - 各OTAのレートプランを順次更新する
          - 更新後の料金一覧をエクスポートし、経営層に報告する
          - サイトコントローラーの同期ログで全OTAへの反映を確認する
        postcondition: 全OTAの料金が統一的に改定され、同期が完了する

  - name: レートプランのサイトコントローラー同期
    description: 登録・更新されたレートプランをサイトコントローラー（ねっぱん、Beds24、TL-Lincoln等）経由で各OTAに配信する。同期方式（料金主導型/在庫主導型）に応じた連携を行い、料金・在庫情報を一元管理する。
    events:
      - レートプラン同期が完了した
      - レートプラン同期が失敗した
    policy:
      - name: 同期失敗リトライポリシー
        trigger: レートプラン同期が失敗した
        action: 一定間隔（5分後、15分後、1時間後）でリトライを実行し、3回失敗後は管理者にアラート通知する
      - name: 同期完了通知ポリシー
        trigger: レートプラン同期が完了した
        action: 同期完了ログを記録し、ダッシュボードの同期ステータスを更新する
    scenarios:
      - name: 定時同期によるOTA料金更新フロー
        precondition: レートプランが更新され、サイトコントローラーとの連携設定が完了している
        steps:
          - システムが更新されたレートプランを検出する
          - サイトコントローラーのAPIにレートプラン情報を送信する
          - サイトコントローラーが各OTAに料金情報を配信する
          - 同期結果（成功/失敗）をログに記録する
          - 失敗した場合は自動リトライを実行する
        postcondition: 全ての対象OTAにレートプラン情報が反映される
      - name: 同期エラー発生時の対応フロー
        precondition: サイトコントローラーとの同期でエラーが発生した
        steps:
          - システムが同期失敗を検知し、エラー内容をログに記録する
          - 自動リトライポリシーに基づきリトライを実行する
          - リトライ上限に達した場合、施設管理者にアラート通知を送信する
          - 施設管理者が同期ログを確認し、エラー原因を特定する
          - 必要に応じて手動で再同期を実行する
        postcondition: 同期エラーが解消され、OTAへの料金反映が完了する

  - name: シーズン料金の自動適用
    description: 予約日がシーズン期間内の場合、対応するシーズン料金（倍率）を自動的に適用する。通常期、繁忙期、閑散期、特別期間の区分に基づき、動的な価格設定を実現する。
    events:
      - シーズン料金が適用された
    policy:
      - name: 予約時シーズン料金適用ポリシー
        trigger: 予約が作成された
        action: 予約日程に該当するシーズンを特定し、シーズン料金倍率を適用した宿泊料金を計算する
    scenarios:
      - name: 予約作成時のシーズン料金自動計算フロー
        precondition: シーズン設定が完了しており、顧客が予約を作成しようとしている
        steps:
          - 顧客が宿泊日程を選択する
          - システムが宿泊日程に該当するシーズンを自動判定する
          - 標準料金にシーズン倍率を適用した料金を計算する
          - 計算された料金を予約画面に表示する
          - 顧客が料金を確認し、予約を確定する
        postcondition: シーズン料金が適用された正確な宿泊料金で予約が作成される
