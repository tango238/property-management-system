# 画面遷移図 - 料金管理

## 概要

料金管理機能は、宿泊料金のシーズン別料金設定とOTA別レートプラン管理を行う機能です。施設管理者がシーズンとレートプランを設定し、サイトコントローラー経由で各OTAに自動同期します。予約管理担当者は顧客対応時にシーズン料金を確認し、正確な見積もりを提供します。

## ユーザーロール

- **施設管理者**: シーズン・レートプランの登録・更新・削除を担当し、料金戦略を立案・実行する責任者
- **予約管理担当者**: 顧客からの料金問い合わせに対応し、シーズン料金を確認して正確な見積もりを提供するスタッフ

---

## 施設管理者のフロー

### メインフロー: シーズン管理

```
[1] シーズン検索画面
├─→ [2] シーズン登録画面 (アクション: 新規登録)
│   └─→ [1] シーズン検索画面 (成功時)
├─→ [3] シーズン更新画面 (アクション: 編集)
│   └─→ [1] シーズン検索画面 (成功時)
│       └─→ レートプラン料金再計算が自動実行
└─→ [4] シーズン削除確認画面 (アクション: 削除)
    ├─→ [1] シーズン検索画面 (成功時)
    └─→ 警告表示 (紐づくレートプランが存在する場合)
```

関連ユースケース:
- シーズンの新規登録
- シーズンの期間・料金倍率更新
- シーズンの削除
- シーズン情報の検索・参照（施設管理者）

### メインフロー: レートプラン管理

```
[5] レートプラン検索画面
├─→ [6] レートプラン登録画面 (アクション: 新規登録)
│   └─→ [5] レートプラン検索画面 (成功時)
│       └─→ サイトコントローラー自動同期開始
├─→ [7] レートプラン更新画面 (アクション: 編集)
│   └─→ [5] レートプラン検索画面 (成功時)
│       └─→ サイトコントローラー自動同期開始
├─→ [8] レートプラン削除確認画面 (アクション: 削除)
│   └─→ [5] レートプラン検索画面 (成功時)
│       └─→ OTA販売停止同期開始
└─→ [9] レートプラン一括更新画面 (アクション: 一括更新)
    ├─→ プレビュー表示
    └─→ [5] レートプラン検索画面 (一括更新成功時)
        └─→ サイトコントローラー一括同期開始
```

関連ユースケース:
- レートプランの新規登録
- 全OTAレートプランの一斉料金改定
- レートプランの削除

### メインフロー: 同期管理

```
[10] 同期ログ画面
├─→ [11] 同期エラー詳細画面 (アクション: 詳細表示)
│   ├─→ [10] 同期ログ画面 (手動再同期成功時)
│   └─→ [10] 同期ログ画面 (スキップ時)
└─→ 手動再同期実行 (アクション: 手動再同期)
    └─→ [10] 同期ログ画面 (同期結果表示)
```

関連ユースケース:
- レートプランのサイトコントローラー自動同期
- 同期エラー発生時の対応と手動再同期

### 統合フロー: シーズン設定からOTA同期まで

```
[1] シーズン検索画面
↓ シーズン設定を確認
[2] シーズン登録画面
↓ 年間シーズンを登録
[5] レートプラン検索画面
↓ レートプラン設定へ移動
[6] レートプラン登録画面
↓ OTA別料金を設定
[10] 同期ログ画面
↓ 同期結果を確認
完了
```

---

## 予約管理担当者のフロー

### メインフロー: 顧客問い合わせ対応

```
[12] シーズン料金確認画面
↓ 問い合わせ日程を入力
↓ シーズン区分・料金倍率を確認
↓ 概算料金を計算
顧客に料金を案内
```

関連ユースケース:
- 顧客問い合わせ対応でのシーズン料金確認

### メインフロー: 予約作成時の料金計算

```
[13] 予約料金計算画面
↓ 宿泊日程を入力
↓ 部屋タイプを選択
↓ シーズン料金が自動適用
↓ 日別料金内訳を確認
├─→ 予約確定へ (料金確認OK)
└─→ 日程・部屋タイプ変更 (料金再計算)
```

関連ユースケース:
- 予約時のシーズン料金自動適用

---

## 重要な遷移

### シーズン登録から料金反映まで

- **起点**: シーズン検索画面
- **終点**: 同期ログ画面
- **トリガー**: 新規シーズン登録
- **条件**: シーズン期間が有効（開始日＜終了日）、重複なし
- **関連ユースケース**: シーズンの新規登録、レートプランの新規登録
- **備考**: シーズン登録後、レートプランで料金設定が必要

### シーズン更新時のレートプラン再計算

- **起点**: シーズン更新画面
- **終点**: 同期ログ画面
- **トリガー**: シーズン情報（期間・料金倍率）の更新
- **条件**: 更新対象シーズンが存在
- **関連ユースケース**: シーズンの期間・料金倍率更新
- **備考**: 更新時にレートプラン再計算ポリシーが自動発動

### レートプラン登録からOTA同期まで

- **起点**: レートプラン登録画面
- **終点**: 同期ログ画面
- **トリガー**: レートプラン登録の確定
- **条件**: OTA種別・部屋タイプ・シーズンの組み合わせが一意
- **関連ユースケース**: レートプランの新規登録、レートプランのサイトコントローラー自動同期
- **備考**: 登録と同時にサイトコントローラーへの同期が開始

### 同期エラー発生時の対応

- **起点**: 同期ログ画面
- **終点**: 同期ログ画面
- **トリガー**: 同期失敗アラート受信
- **条件**: 自動リトライ（3回）が全て失敗
- **関連ユースケース**: 同期エラー発生時の対応と手動再同期
- **備考**: 手動再同期で解消しない場合はサイトコントローラー側の確認が必要

---

## 外部連携ポイント

### サイトコントローラー連携

```
レートプラン登録/更新/削除
       ↓
サイトコントローラーAPI
(ねっぱん/Beds24/TL-Lincoln)
       ↓
┌──────────────────────────────────┐
│  楽天トラベル  │  じゃらん       │
│  Booking.com  │  Airbnb        │
└──────────────────────────────────┘
```

連携タイミング:
- レートプラン登録時: 自動同期
- レートプラン更新時: 即時反映
- レートプラン削除時: 販売停止指示
- 同期失敗時: 自動リトライ（5分後、15分後、1時間後）

---

## エラーフロー

### シーズン登録時のエラー

```
[2] シーズン登録画面
↓ 登録ボタンクリック
├─→ 成功: シーズン検索画面へ戻る
└─→ 失敗: エラーメッセージ表示
    - "開始日は終了日より前である必要があります"
    - "同一期間に重複するシーズンが存在します"
```

### シーズン削除時のエラー

```
[4] シーズン削除確認画面
↓ 削除ボタンクリック
├─→ 成功: シーズン検索画面へ戻る
└─→ 警告: "紐づくレートプランが存在します"
    ├─→ 削除続行
    └─→ キャンセル
```

### レートプラン登録時のエラー

```
[6] レートプラン登録画面
↓ 登録ボタンクリック
├─→ 成功: レートプラン検索画面へ戻る（同期開始）
└─→ 失敗: エラーメッセージ表示
    - "販売開始日は販売終了日より前である必要があります"
    - "同一OTA・部屋タイプ・シーズンの組み合わせが既に存在します"
```

### サイトコントローラー同期エラー

```
同期処理
↓
├─→ 成功: 同期ログに記録
└─→ 失敗: 自動リトライ
    ↓ (5分後、15分後、1時間後)
    ├─→ リトライ成功: 同期ログに記録
    └─→ リトライ失敗(3回): 管理者にアラート通知
        ↓
        [11] 同期エラー詳細画面
        ├─→ 手動再同期
        └─→ スキップ
```

---

## 備考

- シーズン区分は「通常期」「繁忙期」「閑散期」「特別期間」の4種類
- OTA種別は「楽天トラベル」「じゃらん」「Booking.com」「Airbnb」「直接予約」に対応
- サイトコントローラーは「ねっぱん」「Beds24」「TL-Lincoln」に対応
- レートプラン同期方式は「料金主導型」「在庫主導型」から選択可能
- シーズン料金は予約作成時に自動適用される
