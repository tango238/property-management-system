# 予約管理

## 背景

宿泊施設ではOTAやサイトコントローラーを通じて多数の予約が発生する。これらの予約を正確に取り込み、ダブルブッキングを防止しながら、部屋のアサインや予約変更を効率的に処理する必要がある。

## 目的

- サイトコントローラーから予約を自動取得し、手作業によるミスを削減する
- ダブルブッキングを検出・調整し、顧客満足度を維持する
- 予約情報を一覧・カレンダー・検索機能で効率的に管理する
- 予約内容の変更、部屋のアサイン、キャンセル処理を適切に行う

## 主要アクター

- 予約管理担当者
- フロントスタッフ

## 業務概要

予約管理では、サイトコントローラーからの予約取り込み、ダブルブッキングの検出・調整、予約の確認・更新を行う。予約情報は一覧表示、カレンダー表示、検索機能で参照でき、複数施設の予約状況を同時に確認できる。予約の更新では、日程・部屋タイプの変更、ゲスト要望の記録、部屋のアサイン、キャンセル処理が可能である。

## 要求

### 予約管理担当者
サイトコントローラーとの連携設定、外部予約の取り込み・更新、ダブルブッキング調整、在庫・料金調整を行う

### フロントスタッフ
チェックイン・チェックアウト処理、宿泊者名簿の確認、ゲスト要望の更新、部屋のアサインを行う

## 機能

### 予約を取り込む
- 予約を自動取得する
  - 予約を取り込む（イベント：予約を取り込むイベント、外部システム：サイトコントローラー）
  - サイトコントローラーから予約を自動取得する
- 予約の重複を検出する
  - 予約の重複を検出する（画面：予約の重複検出画面、アクター：予約管理担当者）
  - ダブルブッキングの発生を検出する
- 予約の取り込み失敗に対応する
  - 予約取り込みエラーを記録する（画面：予約取り込みエラー記録画面、アクター：予約管理担当者）
  - 取り込み失敗時のエラー情報を記録する

### 予約を確認する
- 予約一覧を表示する
  - 予約を一覧表示する（画面：予約一覧表示画面、アクター：予約管理担当者、フロントスタッフ）
  - 予約情報をリスト形式で表示する
- 予約をカレンダー表示する
  - 予約をカレンダー表示する（画面：予約カレンダー表示画面、アクター：予約管理担当者、フロントスタッフ）
  - 予約情報をカレンダー形式で表示する
- 予約を検索する
  - 予約を検索する（画面：予約検索画面、アクター：予約管理担当者、フロントスタッフ）
  - 条件に基づいて予約を検索する
- 予約詳細を確認する
  - 予約詳細を表示する（画面：予約詳細表示画面、アクター：予約管理担当者、フロントスタッフ）
  - 特定予約の詳細情報を表示する

### 予約を更新する
- 予約内容を変更する
  - 予約を更新する（画面：予約更新画面、アクター：予約管理担当者、フロントスタッフ）
  - 予約の日程や部屋タイプを変更する
- ゲスト要望を追記する
  - ゲスト要望を記録する（画面：ゲスト要望記録画面、アクター：フロントスタッフ）
  - 到着時刻やリクエストを記録する
- 部屋をアサインする
  - 部屋をアサインする（画面：部屋アサイン画面、アクター：予約管理担当者、フロントスタッフ）
  - 予約に具体的な部屋番号を割り当てる
- 予約をキャンセルする
  - 予約をキャンセルする（画面：予約キャンセル画面、アクター：予約管理担当者、フロントスタッフ）
  - 予約を取り消す

### ダブルブッキングを調整する
- 重複予約を確認する
  - 重複予約を一覧表示する（画面：重複予約一覧表示画面、アクター：予約管理担当者）
  - ダブルブッキングの一覧を表示する
- 部屋を再割り当てする
  - 部屋を再割り当てする（画面：部屋再割り当て画面、アクター：予約管理担当者）
  - 重複した予約に別の部屋を割り当てる
- 調整完了を記録する
  - ダブルブッキング解消を記録する（画面：ダブルブッキング解消記録画面、アクター：予約管理担当者）
  - 調整が完了したことを記録する

## ビジネスルール

### ダブルブッキング禁止
- コンテキスト：予約管理
- 説明：同じ部屋・同じ日程で複数の予約確定を許可しない。検出時は即座に調整を行う
- 関連バリエーション：予約状態（仮予約, 予約確定, チェックイン済み, チェックアウト済み, キャンセル）
- 関連状態モデル：予約状態

### 複数施設同時表示
- コンテキスト：予約管理
- 説明：予約管理担当者は、複数施設の予約状況を一画面で確認できる

## ビジネスパラメーター

### 予約状態
- 値：仮予約、予約確定、チェックイン済み、チェックアウト済み、キャンセル
- 説明：予約のライフサイクルを表し、予約管理や売上集計の条件に使用する
- 状態遷移：
  - 仮予約 → 予約確定（予約を取り込む）
  - 予約確定 → チェックイン済み（チェックインを完了する）
  - チェックイン済み → チェックアウト済み（チェックアウトを完了する）
  - 予約確定 → キャンセル（予約をキャンセルする）
  - 仮予約 → キャンセル（予約をキャンセルする）

### OTA種別
- 値：楽天トラベル、じゃらん、Booking.com、Airbnb、直接予約
- 説明：予約の流入元を表し、手数料率の適用やOTA別売上分析に使用する
