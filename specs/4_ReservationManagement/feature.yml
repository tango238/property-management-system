actor:
  - name: 予約管理担当者
    description: サイトコントローラーとの連携設定、外部予約の取り込み・更新、ダブルブッキング調整、在庫・料金調整を担当する。複数施設の予約状況を把握し、効率的な予約管理を実現する。
  - name: フロントスタッフ
    description: チェックイン・チェックアウト処理、宿泊者名簿の確認、ゲスト要望の更新、部屋のアサインを担当する。顧客と直接接点を持ち、現場での予約対応を行う。

external_system:
  - name: サイトコントローラー
    description: 楽天トラベル、じゃらん、Booking.com、Airbnb等の複数OTAからの予約情報を一元管理し、自動的に予約データを連携するシステム

aggregate:
  - 予約
  - ゲスト
  - 部屋
  - 施設
  - ダブルブッキング

feature:
  - name: サイトコントローラーからの予約自動取り込み
    description: サイトコントローラー経由でOTAからの予約を自動取得し、手作業によるミスを削減する。取り込み失敗時はエラー情報を記録し、後で対応できるようにする。
    events:
      - 予約が取り込まれた
      - 予約取り込みが失敗した
    policy:
      - name: ダブルブッキング自動検出ポリシー
        trigger: 予約が取り込まれた
        action: 同一部屋・同一日程の既存予約と重複がないかチェックし、重複があれば警告を発生させる
      - name: 取り込みエラー通知ポリシー
        trigger: 予約取り込みが失敗した
        action: 予約管理担当者にエラー通知を送信し、エラーログを記録する
    scenarios:
      - name: OTA予約の自動取り込みフロー
        precondition: サイトコントローラーとの連携が設定済み、システムが稼働中
        steps:
          - サイトコントローラーから新規予約データを定期的にポーリングする
          - 取得した予約データを検証し、必要な項目が揃っているか確認する
          - 予約情報をシステムに登録する
          - 同一部屋・同一日程の既存予約との重複をチェックする
          - 重複がなければ予約確定、重複があればダブルブッキングとしてフラグを立てる
        postcondition: 予約が取り込まれ、重複がある場合は警告が発生する
      - name: 予約取り込みエラー対応フロー
        precondition: 予約取り込みでエラーが発生した
        steps:
          - エラー内容を確認し、原因を特定する
          - 必要に応じてサイトコントローラーの設定を確認する
          - 手動で予約を入力するか、再取り込みを実行する
          - エラー解消を記録する
        postcondition: エラーが解消され、予約が正常に取り込まれる

  - name: ダブルブッキングの検出・調整
    description: 同一部屋・同一日程で複数予約が発生した場合にダブルブッキングを検出し、予約管理担当者が部屋の再割り当てや調整を行えるようにする。
    events:
      - ダブルブッキングが検出された
      - ダブルブッキングが解消された
    policy:
      - name: ダブルブッキング緊急通知ポリシー
        trigger: ダブルブッキングが検出された
        action: 予約管理担当者に即座に通知し、対応を促す
    scenarios:
      - name: ダブルブッキング解消フロー
        precondition: ダブルブッキングが検出され、予約管理担当者が対応中
        steps:
          - 重複予約一覧画面でダブルブッキングの詳細を確認する
          - 空き部屋の状況を確認し、割り当て可能な部屋を探す
          - 影響の少ない予約を選び、別の部屋に再割り当てする
          - 必要に応じてゲストに連絡し、部屋変更の承諾を得る
          - 調整完了を記録し、ダブルブッキングを解消済みにする
        postcondition: ダブルブッキングが解消され、全予約に部屋が割り当てられる

  - name: 予約の一覧・カレンダー・検索表示
    description: 予約管理担当者とフロントスタッフが予約情報を効率的に確認できるよう、一覧表示、カレンダー表示、条件検索の3つの表示方法を提供する。複数施設の予約状況を同時に確認可能。
    events:
      - 予約一覧が表示された
      - 予約カレンダーが表示された
      - 予約検索が実行された
    policy: []
    scenarios:
      - name: 当日チェックイン予約確認フロー
        precondition: フロントスタッフがログイン済み、当日の予約データが存在する
        steps:
          - 予約一覧画面を開き、本日のチェックイン予約でフィルタする
          - 到着予定時刻順にソートして表示する
          - 各予約の部屋アサイン状況を確認する
          - 未アサインの予約があれば部屋を割り当てる
          - 特別なリクエストがある予約を確認し、準備を指示する
        postcondition: 当日のチェックイン予約が把握され、受け入れ準備が整う
      - name: 週間稼働状況確認フロー
        precondition: 予約管理担当者がログイン済み
        steps:
          - 予約カレンダー画面を開く
          - 表示期間を今週に設定する
          - 複数施設を選択して同時表示する
          - 空室状況と予約の入り具合を視覚的に確認する
          - 空きが多い日程を特定し、販促施策を検討する
        postcondition: 週間の稼働状況が把握され、経営判断の材料が得られる

  - name: 予約詳細の確認・更新
    description: 特定の予約について詳細情報を確認し、日程変更、部屋タイプ変更、ゲスト要望の追記などの更新を行う。予約のライフサイクル全体を通じて情報を管理する。
    events:
      - 予約が更新された
      - ゲスト要望が記録された
    policy:
      - name: 予約変更時の空室チェックポリシー
        trigger: 予約が更新された
        action: 変更後の日程・部屋タイプで空室があるかチェックし、なければ警告を表示する
    scenarios:
      - name: 予約日程変更フロー
        precondition: ゲストから日程変更の依頼があり、該当予約が予約確定状態
        steps:
          - 予約検索画面で予約番号またはゲスト名で検索する
          - 予約詳細を開き、変更可能な状態か確認する
          - 新しい日程を入力し、空室状況をチェックする
          - 空室があれば日程を変更し、料金の差額を計算する
          - 変更内容をゲストに確認し、予約を更新する
        postcondition: 予約日程が変更され、新しい日程で部屋が確保される
      - name: ゲスト特別リクエスト記録フロー
        precondition: ゲストから特別なリクエストの連絡があった
        steps:
          - 予約詳細画面を開く
          - ゲスト要望セクションに到着予定時刻を記録する
          - アレルギー情報や部屋の希望（高層階、禁煙など）を記録する
          - 記念日や特別な目的があれば備考に追記する
          - 関連部門（清掃、レストランなど）に共有が必要な情報をマークする
        postcondition: ゲスト要望が記録され、関連スタッフが確認できる

  - name: 部屋のアサイン
    description: 予約に対して具体的な部屋番号を割り当てる。チェックイン前の事前アサインと、当日の状況に応じた柔軟なアサイン変更に対応する。
    events:
      - 部屋がアサインされた
      - 部屋アサインが変更された
    policy:
      - name: アサイン時の清掃状況チェックポリシー
        trigger: 部屋がアサインされた
        action: 割り当てる部屋の清掃ステータスを確認し、未清掃の場合は警告を表示する
    scenarios:
      - name: チェックイン前日の事前アサインフロー
        precondition: 翌日のチェックイン予約が存在し、部屋の空き状況が確定している
        steps:
          - 翌日チェックインの予約一覧を表示する
          - 各予約の部屋タイプとゲスト要望を確認する
          - 利用可能な部屋の中から、ゲスト要望に合った部屋を選択する
          - 連泊の場合は同じ部屋を継続してアサインする
          - グループ予約の場合は隣接または近い部屋をアサインする
          - アサイン完了後、清掃部門に準備完了依頼を出す
        postcondition: 翌日の全予約に部屋がアサインされ、清掃準備が開始される

  - name: 予約のキャンセル処理
    description: ゲストからのキャンセル依頼を受け付け、予約を取り消す。キャンセルポリシーに基づいたキャンセル料の発生有無を判定し、記録する。
    events:
      - 予約がキャンセルされた
    policy:
      - name: 部屋在庫解放ポリシー
        trigger: 予約がキャンセルされた
        action: キャンセルされた予約の部屋を在庫に戻し、他の予約に割り当て可能にする
      - name: サイトコントローラー同期ポリシー
        trigger: 予約がキャンセルされた
        action: サイトコントローラーにキャンセル情報を送信し、OTA側の在庫を更新する
    scenarios:
      - name: ゲストからのキャンセル受付フロー
        precondition: ゲストからキャンセルの連絡があり、該当予約が予約確定状態
        steps:
          - 予約検索画面で該当予約を特定する
          - 予約詳細を開き、キャンセル処理を開始する
          - キャンセルポリシーを確認し、キャンセル料の発生有無を判定する
          - キャンセル理由を記録する
          - 予約をキャンセル状態に変更する
          - サイトコントローラーにキャンセル情報を同期する
          - 必要に応じてゲストにキャンセル確認メールを送信する
        postcondition: 予約がキャンセルされ、部屋在庫が解放される
