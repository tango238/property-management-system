# 画面遷移図 - 予約管理

## 概要

予約管理機能は、サイトコントローラーからのOTA予約取り込み、ダブルブッキングの検出・調整、予約の確認・更新、部屋のアサイン、キャンセル処理を提供する。予約管理担当者とフロントスタッフが効率的に予約業務を遂行できるようにする。

## ユーザーロール

- **予約管理担当者**: サイトコントローラーとの連携設定、外部予約の取り込み・更新、ダブルブッキング調整、在庫・料金調整を担当
- **フロントスタッフ**: チェックイン・チェックアウト処理、宿泊者名簿の確認、ゲスト要望の更新、部屋のアサインを担当

---

## 予約管理担当者のユーザーフロー

### メインフロー: 予約管理ダッシュボードを起点とした業務

```
[1] 予約管理ダッシュボード
    │
    ├─→ [2] 予約取り込み画面（アクション: 予約取り込み）
    │       │
    │       ├─→ [3] 取り込みエラー一覧画面（アクション: エラー一覧へ）
    │       │       │
    │       │       └─→ [1] 予約管理ダッシュボード（エラー解消後）
    │       │
    │       └─→ [4] ダブルブッキング一覧画面（ダブルブッキング検出時）
    │
    ├─→ [5] 予約一覧画面（アクション: 予約一覧へ）
    │       │
    │       ├─→ [6] 予約詳細画面（アクション: 予約詳細表示）
    │       ├─→ [7] 部屋アサイン画面（アクション: 部屋アサイン）
    │       └─→ [8] 予約キャンセル画面（アクション: キャンセル）
    │
    ├─→ [9] 予約カレンダー画面（アクション: カレンダーへ）
    │       │
    │       ├─→ [6] 予約詳細画面（予約クリック）
    │       └─→ [7] 部屋アサイン画面（アクション: 部屋アサイン）
    │
    ├─→ [4] ダブルブッキング一覧画面（アクション: ダブルブッキング対応へ）
    │       │
    │       └─→ [10] ダブルブッキング再割り当て画面（アクション: 再割り当て）
    │
    └─→ [3] 取り込みエラー一覧画面（アクション: エラー対応へ）
```

関連ユースケース:
- 予約取り込みから部屋アサインまでの一連フロー
- OTA予約の自動取り込みとダブルブッキング検出

---

### フロー1: OTA予約取り込みフロー

```
[1] 予約管理ダッシュボード
    ↓ アクション: 予約取り込み
[2] 予約取り込み画面
    ↓ アクション: 今すぐ取り込み実行
    ├─→ 成功時: サイトコントローラーから予約データ取得
    │   ↓
    │   ├─→ ダブルブッキング検出あり
    │   │   ↓ 通知を受信
    │   │   [4] ダブルブッキング一覧画面
    │   │
    │   └─→ ダブルブッキングなし
    │       ↓
    │       [5] 予約一覧画面（取り込み完了確認）
    │
    └─→ エラー発生時
        ↓ アクション: エラー一覧へ
        [3] 取り込みエラー一覧画面
```

関連ユースケース:
- OTA予約の自動取り込みとダブルブッキング検出
- ダブルブッキングの検出と緊急通知受信

---

### フロー2: 取り込みエラー対応フロー

```
[3] 取り込みエラー一覧画面
    ↓ エラー選択
    ├─→ アクション: 手動入力
    │   ↓
    │   [6] 予約詳細画面（新規作成モード）
    │   ↓ 保存
    │   [3] 取り込みエラー一覧画面（エラー解消を記録）
    │
    ├─→ アクション: 再取り込み
    │   ↓
    │   [2] 予約取り込み画面（該当予約のみ再取り込み）
    │
    └─→ アクション: エラー解消を記録
        ↓
        [3] 取り込みエラー一覧画面（ステータス更新）
```

関連ユースケース:
- 予約取り込みエラーの確認と対応

---

### フロー3: ダブルブッキング解消フロー

```
[4] ダブルブッキング一覧画面
    ↓ 対象ダブルブッキング選択
    ↓ アクション: 再割り当て
[10] ダブルブッキング再割り当て画面
    ↓ 再割り当て先部屋を選択
    ↓ 調整メモを入力（任意）
    ↓ アクション: 再割り当て実行
    ├─→ 成功時
    │   ↓
    │   [4] ダブルブッキング一覧画面（ステータス: 解消済み）
    │
    └─→ 空き部屋なし
        ↓ エラー表示
        [10] ダブルブッキング再割り当て画面（別の部屋を検索）
```

関連ユースケース:
- ダブルブッキングの解消と部屋再割り当て

---

### フロー4: 週間稼働状況確認フロー

```
[1] 予約管理ダッシュボード
    ↓ アクション: カレンダーへ
[9] 予約カレンダー画面
    ↓ 表示期間を「週」に設定
    ↓ 対象施設を選択（複数選択可）
    ↓ 空室状況を視覚的に確認
    ├─→ 予約クリック
    │   ↓
    │   [6] 予約詳細画面
    │
    └─→ 空き多い日程を特定
        ↓ 販促施策を検討
```

関連ユースケース:
- 週間稼働状況のカレンダー確認
- 複数施設の予約状況同時確認

---

### フロー5: チェックイン前日の事前アサインフロー

```
[7] 部屋アサイン画面
    ↓ 対象日を「明日」に設定
    ↓ 「未アサイン一覧」タブを選択
    ↓ 翌日チェックイン予約を確認
    ↓ 各予約の部屋タイプ・ゲスト要望を確認
    │
    ├─→ 連泊予約の場合
    │   ↓ 同じ部屋を継続してアサイン
    │
    ├─→ グループ予約の場合
    │   ↓ 隣接または近い部屋をアサイン
    │
    └─→ 通常予約の場合
        ↓ 部屋番号を選択
        ↓ アクション: アサイン実行
        ↓
        ├─→ 未清掃の場合: 警告表示
        │   ↓ 確認後アサイン or 別の部屋を選択
        │
        └─→ 清掃済みの場合: アサイン完了
            ↓ アクション: 清掃依頼送信
            [7] 部屋アサイン画面（次の予約へ）
```

関連ユースケース:
- チェックイン前日の事前部屋アサイン
- 予約への部屋番号割り当て

---

## フロントスタッフのユーザーフロー

### メインフロー: 予約一覧を起点とした業務

```
[5] 予約一覧画面
    │
    ├─→ [11] 予約検索画面（アクション: 検索）
    │       ↓ 検索結果
    │       └─→ [6] 予約詳細画面
    │
    ├─→ [6] 予約詳細画面（アクション: 予約詳細表示）
    │       │
    │       ├─→ [7] 部屋アサイン画面（アクション: 部屋アサイン）
    │       └─→ [8] 予約キャンセル画面（アクション: キャンセル処理）
    │
    ├─→ [7] 部屋アサイン画面（アクション: 部屋アサイン）
    │
    └─→ [8] 予約キャンセル画面（アクション: キャンセル）
```

---

### フロー6: 当日チェックイン予約確認フロー

```
[5] 予約一覧画面
    ↓ チェックイン日を「本日」でフィルタ
    ↓ 到着予定時刻順でソート
    ↓ 各予約の部屋アサイン状況を確認
    │
    ├─→ 未アサインの予約あり
    │   ↓ アクション: 部屋アサイン
    │   [7] 部屋アサイン画面
    │   ↓ 部屋を割り当て
    │   [5] 予約一覧画面に戻る
    │
    └─→ 特別リクエストあり
        ↓ アクション: 予約詳細表示
        [6] 予約詳細画面
        ↓ 「ゲスト要望」タブを確認
        ↓ 関連部門に共有
```

関連ユースケース:
- 当日チェックイン予約の確認と受け入れ準備

---

### フロー7: 予約検索フロー

```
[11] 予約検索画面
    ↓ 検索条件を入力
    │   - 予約番号
    │   - ゲスト名
    │   - 電話番号
    │   - メールアドレス
    │   - チェックイン日（From/To）
    │   - 部屋タイプ
    │   - OTA種別
    │   - 予約状態
    ↓ アクション: 検索
    ↓ 検索結果一覧を表示
    │
    ├─→ 該当予約あり
    │   ↓ アクション: 予約詳細表示
    │   [6] 予約詳細画面
    │
    └─→ 該当予約なし
        ↓ 検索条件を変更
        [11] 予約検索画面
```

関連ユースケース:
- 予約の検索

---

### フロー8: 予約日程変更フロー

```
[6] 予約詳細画面
    ↓ 「基本情報」タブを開く
    ↓ チェックイン日/チェックアウト日を変更
    ↓ アクション: 保存
    │
    ├─→ 空室あり
    │   ↓ 料金差額を表示
    │   ↓ 変更確定
    │   [6] 予約詳細画面（更新完了）
    │   ↓ サイトコントローラーに同期
    │
    └─→ 空室なし
        ↓ 警告: 「指定日程に空室がありません」
        [6] 予約詳細画面（日程を再選択）
```

関連ユースケース:
- 予約日程・部屋タイプの変更

---

### フロー9: ゲスト特別リクエスト記録フロー

```
[6] 予約詳細画面
    ↓ 「ゲスト要望」タブを開く
    ↓ 以下を記録:
    │   - 到着予定時刻
    │   - アレルギー情報
    │   - 部屋の希望（高層階、禁煙等）
    │   - 特別リクエスト
    │   - 部門共有メモ
    ↓ アクション: 保存
    [6] 予約詳細画面（保存完了）
```

関連ユースケース:
- ゲスト特別リクエストの記録

---

### フロー10: 予約キャンセルフロー

```
[8] 予約キャンセル画面
    ↓ 予約情報を確認
    │   - 予約番号、ゲスト名、日程
    │   - 料金合計、キャンセルポリシー
    │   - キャンセル料
    ↓ キャンセル理由を選択
    ↓ キャンセル理由詳細を入力（任意）
    │
    ├─→ キャンセル料免除する場合
    │   ↓ 「免除する」を選択
    │   ↓ 免除理由を入力（必須）
    │
    └─→ キャンセル料免除しない場合
        ↓ 「免除しない」を選択

    ↓ アクション: キャンセル確定
    ↓ 確認ダイアログ表示
    ├─→ 確認: はい
    │   ↓ 予約をキャンセル状態に更新
    │   ↓ 部屋在庫を解放
    │   ↓ サイトコントローラーに同期
    │   [5] 予約一覧画面
    │
    └─→ 確認: いいえ
        [8] 予約キャンセル画面に戻る
```

関連ユースケース:
- 予約キャンセルとキャンセル料判定
- キャンセルによる在庫解放とOTA同期

---

### フロー11: 当日の部屋アサイン変更フロー

```
[7] 部屋アサイン画面
    ↓ 「アサイン済み一覧」タブを選択
    ↓ 変更対象の予約を選択
    ↓ アクション: アサイン変更
    ↓ 利用可能な部屋を確認
    ↓ 新しい部屋番号を選択
    │
    ├─→ 未清掃の場合
    │   ↓ 警告表示
    │   ↓ 確認後変更 or 別の部屋を選択
    │
    └─→ 清掃済みの場合
        ↓ アサイン変更を保存
        [7] 部屋アサイン画面（変更完了）
```

関連ユースケース:
- 当日の部屋アサイン変更

---

## 主要な画面遷移

| 遷移元 | 遷移先 | トリガー | 条件 | 関連ユースケース |
|--------|--------|----------|------|------------------|
| 予約管理ダッシュボード | 予約取り込み画面 | 予約取り込み | - | OTA予約の自動取り込みとダブルブッキング検出 |
| 予約取り込み画面 | ダブルブッキング一覧画面 | 取り込み完了 | ダブルブッキング検出時 | ダブルブッキングの検出と緊急通知受信 |
| 予約取り込み画面 | 取り込みエラー一覧画面 | エラー一覧へ | エラー発生時 | 予約取り込みエラーの確認と対応 |
| 予約一覧画面 | 予約詳細画面 | 予約詳細表示 | - | 予約日程・部屋タイプの変更 |
| 予約一覧画面 | 部屋アサイン画面 | 部屋アサイン | - | 予約への部屋番号割り当て |
| 予約一覧画面 | 予約キャンセル画面 | キャンセル | 予約確定状態 | 予約キャンセルとキャンセル料判定 |
| 予約詳細画面 | 部屋アサイン画面 | 部屋アサイン | - | 予約への部屋番号割り当て |
| ダブルブッキング一覧画面 | ダブルブッキング再割り当て画面 | 再割り当て | - | ダブルブッキングの解消と部屋再割り当て |
| 予約キャンセル画面 | 予約一覧画面 | キャンセル確定 | 確認ダイアログでOK | キャンセルによる在庫解放とOTA同期 |

---

## 外部システム連携

### サイトコントローラー連携

| 画面 | 連携タイミング | 連携内容 |
|------|----------------|----------|
| 予約取り込み画面 | 取り込み実行時 | OTA予約データの取得 |
| 予約詳細画面 | 予約更新保存時 | 予約変更情報の同期 |
| 予約キャンセル画面 | キャンセル確定時 | キャンセル情報・在庫解放の同期 |

---

## エラーフロー

### 予約取り込みエラー

```
[2] 予約取り込み画面
    ↓ 取り込み処理実行
    ↓ エラー発生
    ├─→ 接続エラー
    │   ↓ エラーメッセージ: 「サイトコントローラーに接続できません」
    │   ↓ 再試行 or 設定確認
    │
    ├─→ データ不整合エラー
    │   ↓ [3] 取り込みエラー一覧画面
    │   ↓ 手動入力 or 再取り込み
    │
    └─→ 認証エラー
        ↓ エラーメッセージ: 「認証に失敗しました」
        ↓ 連携設定を確認
```

### 部屋アサインエラー

```
[7] 部屋アサイン画面
    ↓ 部屋選択・アサイン実行
    ├─→ 未清掃警告
    │   ↓ 警告ダイアログ: 「この部屋は未清掃です」
    │   ├─→ 続行: アサイン実行
    │   └─→ キャンセル: 別の部屋を選択
    │
    └─→ 既にアサイン済み
        ↓ エラーメッセージ: 「この部屋は既に他の予約にアサインされています」
        ↓ 別の部屋を選択
```

### 日程変更エラー

```
[6] 予約詳細画面
    ↓ 日程変更・保存
    ├─→ 空室なしエラー
    │   ↓ 警告: 「指定日程に空室がありません」
    │   ↓ 日程を再選択
    │
    └─→ チェックアウト日エラー
        ↓ バリデーションエラー: 「チェックアウト日はチェックイン日より後にしてください」
        ↓ 日付を修正
```

### キャンセルエラー

```
[8] 予約キャンセル画面
    ↓ キャンセル確定
    ├─→ チェックイン済みエラー
    │   ↓ エラー: 「チェックイン済みの予約はキャンセルできません」
    │   ↓ [5] 予約一覧画面に戻る
    │
    └─→ 免除理由未入力エラー
        ↓ バリデーションエラー: 「キャンセル料免除の場合は理由を入力してください」
        ↓ 免除理由を入力
```

---

## 備考

- 予約状態の遷移: 仮予約 → 予約確定 → チェックイン済み → チェックアウト済み
- キャンセル可能な状態: 仮予約、予約確定（チェックイン済み以降は不可）
- ダブルブッキング検出は予約取り込み時に自動実行
- 連泊・グループ予約は部屋アサイン時に特別な考慮が必要
- OTA種別: 楽天トラベル、じゃらん、Booking.com、Airbnb、直接予約
