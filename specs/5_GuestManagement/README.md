# 宿泊者管理

## 背景

宿泊施設では旅館業法に基づき宿泊者名簿の記入と保管が義務付けられている。チェックイン前に宿泊者情報を取得し、スムーズなチェックイン・チェックアウト処理を実現する必要がある。また、宿泊者名簿を3年間保管することで法令遵守を徹底する。

## 目的

- チェックイン前日に案内メールを送信し、宿泊者名簿の事前記入を促す
- トークンによる一時URLで、セキュアに宿泊者情報を収集する
- 宿泊者名簿の記入状況を管理し、未記入の場合はフロントで記入を促す
- チェックイン・チェックアウト処理を効率的に行い、部屋状態を適切に更新する

## 主要アクター

- フロントスタッフ
- ゲスト

## 業務概要

宿泊者管理では、チェックイン案内の送信、宿泊者名簿の記入・管理、チェックイン・チェックアウト処理を行う。チェックイン前日に予約を抽出し、24時間有効なトークン付き案内メールを送信する。ゲストはトークンを使って宿泊者名簿を記入し、フロントスタッフは記入状況を確認してチェックイン処理を行う。チェックアウト時は精算内容を表示し、部屋状態をDirtyに変更する。

## 要求

### ゲスト
宿泊者名簿の入力、予約内容の確認、事前要望の入力を行う

### フロントスタッフ
チェックイン・チェックアウト処理、宿泊者名簿の確認、ゲスト要望の更新、部屋のアサインを行う

## 機能

### チェックイン案内を送信する
- 送信対象を抽出する
  - チェックイン案内対象を抽出する（情報：予約）
  - チェックイン前日の予約を抽出する
- トークンを発行する
  - トークンを発行する（画面：トークン発行画面、アクター：トークン有効期限24時間）
  - 宿泊者名簿記入用の一時URLを生成する
- メールを送信する
  - チェックイン案内メールを送信する（イベント：チェックイン案内メールを送信イベント、外部システム：メール配信システム）
  - ゲストに案内メールを送信する
- 送信失敗に対応する
  - メール送信エラーを記録する（イベント：メール送信エラーを記録イベント、外部システム：メール配信システム）
  - 送信失敗時のエラー情報を記録する

### 宿泊者名簿を記入する
- トークンを検証する
  - トークンを検証する（画面：トークン検証画面、アクター：ゲスト）
  - URLの有効性を確認する
- 宿泊者情報を入力する
  - 宿泊者名簿を入力する（画面：宿泊者名簿入力画面、アクター：ゲスト）
  - 氏名・住所などを入力する
- 入力内容を保存する
  - 宿泊者名簿を保存する（画面：宿泊者名簿保存画面、アクター：ゲスト）
  - 入力された宿泊者情報を保存する

### 宿泊者名簿を管理する
- 宿泊者名簿を検索する
  - 宿泊者名簿を検索する（画面：宿泊者名簿検索画面、アクター：フロントスタッフ）
  - 条件に基づいて宿泊者名簿を検索する
- 宿泊者名簿を確認する
  - 宿泊者名簿を表示する（画面：宿泊者名簿表示画面、アクター：フロントスタッフ）
  - 記入済みの宿泊者名簿を表示する
- 未記入を確認する
  - 未記入名簿を一覧表示する（画面：未記入名簿一覧表示画面、アクター：フロントスタッフ）
  - 記入されていない宿泊者名簿を抽出する
- 宿泊者名簿を保管する
  - 宿泊者名簿を保管する（画面：宿泊者名簿保管画面、アクター：フロントスタッフ）
  - 法令に従って宿泊者名簿を保管する

### チェックインを処理する
- ゲスト到着を確認する
  - ゲスト到着を記録する（画面：ゲスト到着記録画面、アクター：フロントスタッフ）
  - ゲストの到着を記録する
- 宿泊者名簿を確認する
  - 宿泊者名簿記入状況を確認する（画面：宿泊者名簿記入状況確認画面、アクター：フロントスタッフ）
  - 宿泊者名簿が記入済みか確認する
- 部屋をアサインする
  - チェックイン時部屋を確定する（画面：チェックイン時部屋確定画面、アクター：フロントスタッフ）
  - 最終的な部屋番号を確定する
- チェックイン完了を記録する
  - チェックインを完了する（画面：チェックイン完了画面、アクター：フロントスタッフ）
  - チェックイン処理の完了を記録する

### チェックアウトを処理する
- 精算内容を確認する
  - 精算内容を表示する（画面：精算内容表示画面、アクター：フロントスタッフ）
  - 宿泊料金や追加料金を表示する
- チェックアウトを記録する
  - チェックアウトを完了する（画面：チェックアウト完了画面、アクター：フロントスタッフ）
  - ゲストの退出を記録する
- 部屋状態を変更する
  - 部屋を清掃前状態にする（画面：部屋清掃前状態に画面、アクター：フロントスタッフ）
  - チェックアウト後の部屋をDirty状態にする

## ビジネスルール

### 宿泊者名簿記入必須
- コンテキスト：宿泊者管理
- 説明：チェックインまでに宿泊者名簿が記入されていない場合、フロントで記入を促す
- 関連バリエーション：宿泊者名簿記入状態（未記入, 記入依頼送信済み, 記入完了, 確認済み）
- 関連状態モデル：宿泊者名簿状態

### トークン有効期限24時間
- コンテキスト：宿泊者管理
- 説明：宿泊者名簿記入用トークンは発行から24時間で期限切れとする
- 関連バリエーション：トークン状態（未発行, 発行済み, 使用済み, 期限切れ）
- 関連状態モデル：トークン状態

### 宿泊者名簿保存期間3年
- コンテキスト：宿泊者管理
- 説明：旅館業法に基づき、宿泊者名簿を3年間保存する

### チェックアウト後即時清掃依頼
- コンテキスト：清掃管理
- 説明：チェックアウトが完了したら、部屋を即座に清掃対象リストに追加する
- 関連バリエーション：部屋状態ステータス、清掃状態
- 関連状態モデル：部屋状態、清掃状態

## ビジネスパラメーター

### 宿泊者名簿記入状態
- 値：未記入、記入依頼送信済み、記入完了、確認済み
- 説明：宿泊者名簿の記入状況を表し、チェックイン処理の可否判定に使用する
- 状態遷移：
  - 未記入 → 記入依頼送信済み（チェックイン案内メールを送信する）
  - 記入依頼送信済み → 記入完了（宿泊者名簿を保存する）
  - 記入完了 → 確認済み（宿泊者名簿記入状況を確認する）

### トークン状態
- 値：未発行、発行済み、使用済み、期限切れ
- 説明：トークンの有効性を表し、宿泊者名簿記入時のアクセス制御に使用する
- 状態遷移：
  - 未発行 → 発行済み（トークンを発行する）
  - 発行済み → 使用済み（宿泊者名簿を保存する）
  - 発行済み → 期限切れ（トークンを検証する）
