# 画面遷移図 - 宿泊者管理

## 概要

宿泊者管理機能は、チェックイン前日の案内メール送信から、宿泊者名簿の記入、チェックイン・チェックアウト処理までの一連のゲスト対応フローを提供します。フロントスタッフとゲストの両者が利用し、旅館業法に基づく宿泊者名簿の管理を効率的に行います。

## ユーザーロール

- **フロントスタッフ**: チェックイン・チェックアウト処理を担当する宿泊施設の従業員。宿泊者名簿の確認、部屋のアサイン、精算処理を行う。
- **ゲスト**: 宿泊施設を利用する顧客。チェックイン前に宿泊者名簿を記入し、予約内容の確認を行う。

---

## フロントスタッフ ユーザーフロー

### メインフロー: 日次業務フロー

```
[1] 案内メール送信画面
    │
    ├─→ [2] 送信エラー一覧画面（エラー発生時）
    │       └─→ [1] 案内メール送信画面（再送信後）
    │
    ↓ 翌日
[3] 到着予定一覧画面
    │
    ├─→ [4] 宿泊者名簿詳細画面（名簿確認時）
    │       └─→ [3] 到着予定一覧画面（戻る）
    │
    ↓ ゲスト到着時
[5] チェックイン処理画面
    │
    ├─→ [6] フロント宿泊者名簿入力画面（名簿未記入の場合）
    │       └─→ [5] チェックイン処理画面（保存後）
    │
    ↓ チェックイン完了
    ↓ ゲスト滞在中
    ↓
[7] チェックアウト処理画面
    │
    └─→ 完了（部屋状態をDirtyに変更、清掃チームへ通知）
```

関連ユースケース:
- チェックイン案内メールの一括送信
- メール送信エラーの確認と対応
- 本日到着ゲストの宿泊者名簿記入状況確認
- 事前記入済みゲストのチェックイン処理
- 宿泊者名簿未記入ゲストのチェックイン処理
- 通常チェックアウト処理
- 追加料金発生時のチェックアウト処理

---

### 案内メール送信フロー

```
[1] 案内メール送信画面
    │
    ├─ フィルター: チェックイン日で抽出
    │
    ├─→ 「対象を抽出」クリック
    │       ↓
    │   送信対象一覧を表示
    │
    ├─→ 「一括送信」クリック
    │       ↓
    │   トークン発行・メール送信
    │       │
    │       ├─ 成功 → 送信結果を表示
    │       │
    │       └─ 一部失敗 → [2] 送信エラー一覧画面
    │
    └─→ 「個別送信」クリック
            ↓
        選択した予約にのみ送信
```

関連ユースケース:
- チェックイン案内メールの一括送信

---

### チェックイン処理フロー（事前記入済み）

```
[5] チェックイン処理画面
    │
    ├─ 予約検索（予約番号またはゲスト名）
    │       ↓
    │   予約情報・名簿記入状態を表示
    │
    ├─ タブ切替: 予約情報 / 宿泊者名簿 / 部屋アサイン
    │
    ├─→ 「名簿確認」クリック
    │       ↓
    │   宿泊者名簿内容サマリーを表示
    │       │
    │       └─ 記入済み → 確認OK
    │
    ├─→ 「部屋確定」クリック
    │       ↓
    │   利用可能部屋一覧から選択
    │       │
    │       └─ 検証: 部屋がClean状態であること
    │
    └─→ 「チェックイン完了」クリック
            ↓
        部屋状態を使用中に更新
            ↓
        鍵を渡す準備完了
```

関連ユースケース:
- 事前記入済みゲストのチェックイン処理

---

### チェックイン処理フロー（名簿未記入）

```
[5] チェックイン処理画面
    │
    ├─ 予約検索
    │       ↓
    │   名簿記入状態: 未記入を検出
    │
    └─→ 「フロント記入モードへ」クリック
            ↓
    [6] フロント宿泊者名簿入力画面
        │
        ├─ 入力項目:
        │   ・氏名（漢字・フリガナ）
        │   ・郵便番号・住所
        │   ・電話番号・メールアドレス
        │   ・国籍・職業
        │   ・同伴者情報
        │
        ├─→ 「署名入力」クリック
        │       ↓
        │   署名を記録
        │
        ├─→ 「保存」クリック
        │       ↓
        │   検証: 必須項目が全て入力されていること
        │       │
        │       ├─ 成功 → [5] チェックイン処理画面に戻る
        │       │
        │       └─ 失敗 → エラー表示
        │
        └─→ 「キャンセル」クリック
                ↓
            [5] チェックイン処理画面に戻る
```

関連ユースケース:
- 宿泊者名簿未記入ゲストのチェックイン処理

---

### チェックアウト処理フロー

```
[7] チェックアウト処理画面
    │
    ├─ 予約検索（予約番号または部屋番号）
    │       ↓
    │   予約情報・精算内容を表示
    │
    ├─ タブ切替: 精算内容 / 追加料金明細
    │
    ├─ 表示項目:
    │   ・基本宿泊料金
    │   ・追加料金一覧（ミニバー、ルームサービス等）
    │   ・合計金額・税額内訳
    │
    ├─→ 支払方法を選択
    │       ↓
    │   現金 / クレジットカード / 電子マネー / 請求書払い
    │
    ├─→ 「精算実行」クリック
    │       ↓
    │   決済システム連携
    │       │
    │       ├─ 成功 → 精算完了
    │       │
    │       └─ 失敗 → エラー表示
    │
    ├─→ 「チェックアウト完了」クリック
    │       ↓
    │   検証: 精算完了後のみ実行可能
    │       ↓
    │   部屋状態をDirtyに変更
    │       ↓
    │   清掃チームへ通知
    │
    ├─→ 「領収書発行」クリック
    │       ↓
    │   領収書を印刷
    │
    └─→ 「明細印刷」クリック
            ↓
        精算明細を印刷
```

関連ユースケース:
- 通常チェックアウト処理
- 追加料金発生時のチェックアウト処理

---

### 宿泊者名簿検索・管理フロー

```
[8] 宿泊者名簿検索画面
    │
    ├─ 検索条件:
    │   ・ゲスト氏名
    │   ・宿泊日（From/To）
    │   ・予約番号
    │
    ├─→ 「検索」クリック
    │       ↓
    │   検索結果一覧を表示
    │
    ├─→ 「詳細表示」クリック
    │       ↓
    │   [4] 宿泊者名簿詳細画面
    │       │
    │       ├─→ 「印刷」クリック → 名簿を印刷
    │       │
    │       ├─→ 「編集」クリック → 編集モード
    │       │       │
    │       │       └─ 検証: チェックイン完了後は編集不可
    │       │
    │       └─→ 「戻る」クリック
    │               ↓
    │           [8] 宿泊者名簿検索画面
    │
    ├─→ 「CSV出力」クリック
    │       ↓
    │   検索結果をCSVダウンロード
    │
    └─→ 「クリア」クリック
            ↓
        検索条件をリセット
```

関連ユースケース:
- 宿泊者名簿の検索・閲覧

---

### 名簿保管管理フロー

```
[9] 名簿保管管理画面
    │
    ├─ フィルター: 保管年度 / 保管期限
    │
    ├─ 表示項目:
    │   ・保管中名簿件数
    │   ・保管期限切れ予定件数（3年経過）
    │   ・名簿一覧
    │
    ├─→ 「保管処理実行」クリック
    │       ↓
    │   3年保管設定を適用
    │       ↓
    │   保管完了を表示
    │
    ├─→ 「期限切れ名簿削除」クリック
    │       ↓
    │   検証: 3年以上経過した名簿のみ削除可能
    │       │
    │       ├─ 成功 → 削除完了
    │       │
    │       └─ 失敗 → エラー表示（3年未満は削除不可）
    │
    └─→ 「保管証明書発行」クリック
            ↓
        保管証明書を発行
```

関連ユースケース:
- 宿泊者名簿の法定保管

---

## ゲスト ユーザーフロー

### メインフロー: 事前宿泊者名簿記入フロー

```
[メール受信] 案内メールを受信
    │
    ↓ URLをクリック
[A] トークン検証
    │
    ├─ トークン有効 ─→ [B] 宿泊者名簿入力画面
    │                       │
    │                       ├─ 入力項目:
    │                       │   ・氏名（漢字・フリガナ）
    │                       │   ・郵便番号・住所
    │                       │   ・電話番号・メールアドレス
    │                       │   ・国籍・職業
    │                       │   ・同伴者情報
    │                       │
    │                       ├─ 表示項目:
    │                       │   ・予約情報（チェックイン日、部屋タイプ）
    │                       │   ・施設名
    │                       │
    │                       └─→ 「入力内容を確認」クリック
    │                               ↓
    │                       [C] 宿泊者名簿入力確認画面
    │                           │
    │                           ├─→ 「戻って修正」クリック
    │                           │       ↓
    │                           │   [B] 宿泊者名簿入力画面
    │                           │
    │                           └─→ 「送信」クリック
    │                                   ↓
    │                               検証: 必須項目が全て入力されていること
    │                                   │
    │                                   ├─ 成功 → [D] 宿泊者名簿入力完了画面
    │                                   │               │
    │                                   │               └─ 表示: 完了メッセージ、
    │                                   │                       チェックイン日時、
    │                                   │                       施設住所、注意事項
    │                                   │
    │                                   └─ 失敗 → エラー表示
    │
    └─ トークン期限切れ ─→ [E] トークン期限切れ画面
                                │
                                └─ 表示: 期限切れメッセージ、
                                        フロントデスク連絡先、
                                        チェックイン時の対応案内
```

関連ユースケース:
- ゲストによる事前宿泊者名簿記入
- トークン期限切れ時の案内表示

---

## 主要な画面遷移

### 案内メール送信 → エラー確認

- **遷移元**: 案内メール送信画面
- **遷移先**: 送信エラー一覧画面
- **トリガー**: 一括送信実行後、一部送信失敗が発生
- **条件**: エラーが1件以上存在
- **関連ユースケース**: メール送信エラーの確認と対応
- **備考**: エラー対応後は案内メール送信画面に戻り再送信可能

### 到着予定一覧 → チェックイン処理

- **遷移元**: 到着予定一覧画面
- **遷移先**: チェックイン処理画面
- **トリガー**: 「チェックイン処理へ進む」アクション
- **条件**: ゲストが到着している
- **関連ユースケース**: 事前記入済みゲストのチェックイン処理、宿泊者名簿未記入ゲストのチェックイン処理
- **備考**: 名簿記入状態により後続フローが分岐

### チェックイン処理 → フロント名簿入力

- **遷移元**: チェックイン処理画面
- **遷移先**: フロント宿泊者名簿入力画面
- **トリガー**: 「フロント記入モードへ」アクション
- **条件**: 宿泊者名簿が未記入状態
- **関連ユースケース**: 宿泊者名簿未記入ゲストのチェックイン処理
- **備考**: 入力完了後はチェックイン処理画面に戻る

### 宿泊者名簿入力 → 確認 → 完了（ゲスト）

- **遷移元**: 宿泊者名簿入力画面
- **遷移先**: 宿泊者名簿入力確認画面 → 宿泊者名簿入力完了画面
- **トリガー**: 「入力内容を確認」→「送信」アクション
- **条件**: トークンが有効期限内、必須項目が全て入力済み
- **関連ユースケース**: ゲストによる事前宿泊者名簿記入
- **備考**: 確認画面で「戻って修正」により入力画面に戻ることが可能

### トークン検証 → 期限切れ画面

- **遷移元**: （URL直接アクセス）
- **遷移先**: トークン期限切れ画面
- **トリガー**: 案内メールのURLクリック
- **条件**: トークン発行から24時間を超過
- **関連ユースケース**: トークン期限切れ時の案内表示
- **備考**: フロントでの対応案内を表示

---

## 外部システム連携

### メール配信システム

- **連携画面**: 案内メール送信画面
- **連携内容**: チェックイン案内メールの一括送信
- **トリガー**: 「一括送信」「個別送信」アクション
- **エラー時**: 送信エラー一覧画面でエラー情報を確認可能

### 決済システム

- **連携画面**: チェックアウト処理画面
- **連携内容**: 精算処理（クレジットカード、電子マネー決済）
- **トリガー**: 「精算実行」アクション
- **エラー時**: エラー表示、再試行可能

---

## エラーフロー

### メール送信エラー

```
[1] 案内メール送信画面
    ↓ 一括送信実行
エラー発生（一部失敗）
    ↓
[2] 送信エラー一覧画面
    ├─ エラー内容を確認
    ├─ 「再送信」で再試行
    └─ 「対応済みマーク」で対応完了を記録
```

### トークン期限切れ

```
[ゲスト] URLにアクセス
    ↓
トークン検証: 期限切れ
    ↓
[E] トークン期限切れ画面
    └─ フロントデスク連絡先を表示
        └─ チェックイン時にフロントで名簿記入
```

### 精算エラー

```
[7] チェックアウト処理画面
    ↓ 精算実行
決済システムエラー
    ↓
エラー表示
    ├─ 別の支払方法を選択
    └─ 再試行
```

### バリデーションエラー（名簿入力）

```
[B] 宿泊者名簿入力画面 / [6] フロント宿泊者名簿入力画面
    ↓ 送信/保存
必須項目未入力エラー
    ↓
エラー表示（該当項目をハイライト）
    ↓
修正して再送信
```

---

## 備考

- トークンの有効期限は発行から24時間
- 宿泊者名簿はチェックイン完了後は編集不可
- 旅館業法に基づき宿泊者名簿は3年間保管必須
- 部屋アサインは清掃完了（Clean）状態の部屋のみ選択可能
- チェックアウト完了時に部屋状態は自動的にDirtyに変更される
